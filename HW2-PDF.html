<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Do you think that the number of plans is sufficient, too few, or too many?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="HW2-submission1_files/libs/clipboard/clipboard.min.js"></script>
<script src="HW2-submission1_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="HW2-submission1_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="HW2-submission1_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="HW2-submission1_files/libs/quarto-html/popper.min.js"></script>
<script src="HW2-submission1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="HW2-submission1_files/libs/quarto-html/anchor.min.js"></script>
<link href="HW2-submission1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="HW2-submission1_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="HW2-submission1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="HW2-submission1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="HW2-submission1_files/libs/bootstrap/bootstrap-3bf800c68306cd81224625c588ae8699.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Do you think that the number of plans is sufficient, too few, or too many?</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="1aa2cfb6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install statsmodels</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install scikit<span class="op">-</span>learn</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> NearestNeighbors</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>Requirement already satisfied: statsmodels in /home/pturn22/econ470/a0/pyenv/lib/python3.13/site-packages (0.14.6)

Requirement already satisfied: numpy&lt;3,&gt;=1.22.3 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from statsmodels) (2.3.5)

Requirement already satisfied: scipy!=1.9.2,&gt;=1.8 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from statsmodels) (1.15.3)

Requirement already satisfied: pandas!=2.1.0,&gt;=1.4 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from statsmodels) (2.3.3)

Requirement already satisfied: patsy&gt;=0.5.6 in /home/pturn22/econ470/a0/pyenv/lib/python3.13/site-packages (from statsmodels) (1.0.2)

Requirement already satisfied: packaging&gt;=21.3 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from statsmodels) (25.0)

Requirement already satisfied: python-dateutil&gt;=2.8.2 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2.9.0.post0)

Requirement already satisfied: pytz&gt;=2020.1 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2025.2)

Requirement already satisfied: tzdata&gt;=2022.7 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2025.2)

Requirement already satisfied: six&gt;=1.5 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (1.17.0)



<span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> A new release of pip is available: <span class="ansi-red-fg">24.2</span> -&gt; <span class="ansi-green-fg">26.0.1</span>

<span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> To update, run: <span class="ansi-green-fg">pip install --upgrade pip</span>

Requirement already satisfied: scikit-learn in /home/pturn22/econ470/a0/pyenv/lib/python3.13/site-packages (1.8.0)

Requirement already satisfied: numpy&gt;=1.24.1 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from scikit-learn) (2.3.5)

Requirement already satisfied: scipy&gt;=1.10.0 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from scikit-learn) (1.15.3)

Requirement already satisfied: joblib&gt;=1.3.0 in /local/5261/econ470001/a0/conda-env/lib/python3.13/site-packages (from scikit-learn) (1.5.2)

Requirement already satisfied: threadpoolctl&gt;=3.2.0 in /home/pturn22/econ470/a0/pyenv/lib/python3.13/site-packages (from scikit-learn) (3.6.0)



<span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> A new release of pip is available: <span class="ansi-red-fg">24.2</span> -&gt; <span class="ansi-green-fg">26.0.1</span>

<span class="ansi-bold">[</span><span class="ansi-blue-fg">notice</span><span class="ansi-bold">]</span> To update, run: <span class="ansi-green-fg">pip install --upgrade pip</span>
</pre>
</div>
</div>
</div>
<div id="2c892c5b" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> pd.read_csv(<span class="st">"../data/output/master_data.csv"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"../data/output/master_data.csv"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/1682891055.py:1: DtypeWarning: Columns (23,24,41,42,44,61) have mixed types. Specify dtype option on import or set low_memory=False.
  data = pd.read_csv("../data/output/master_data.csv")
/tmp/ipykernel_1471476/1682891055.py:2: DtypeWarning: Columns (23,24,41,42,44,61) have mixed types. Specify dtype option on import or set low_memory=False.
  df = pd.read_csv("../data/output/master_data.csv")</code></pre>
</div>
</div>
<div id="f4de6cda" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (df.head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  contractid  planid     fips  year  n_nonmiss  avg_enrollment  sd_enrollment  \
0      H0028     1.0  19103.0  2014          2           238.0       2.828427   
1      H0028     1.0  19113.0  2014          2          1334.5       4.949747   
2      H0028     2.0  19153.0  2014          2           347.0       1.414214   
3      H0028     3.0  19155.0  2014          2           173.0      11.313708   
4      H0028     4.0  15003.0  2014          2          1019.5      20.506097   

   min_enrollment  max_enrollment  first_enrollment  ...  rebate_partc  \
0           236.0           240.0             240.0  ...           NaN   
1          1331.0          1338.0            1338.0  ...           NaN   
2           346.0           348.0             346.0  ...         49.83   
3           165.0           181.0             165.0  ...         30.69   
4          1005.0          1034.0            1034.0  ...         48.97   

  year_reb payment_partd directsubsidy_partd reinsurance_partd  \
0      NaN           NaN                 NaN               NaN   
1      NaN           NaN                 NaN               NaN   
2   2014.0        105.11               41.05             26.97   
3   2014.0        110.04               43.02             29.06   
4   2014.0         70.39               41.78             14.45   

  costsharing_partd riskscore_partd basic_premium         bid contract_id  
0               NaN             NaN           NaN         NaN         NaN  
1               NaN             NaN           NaN         NaN         NaN  
2             37.09           0.910           0.0  806.179654         NaN  
3             37.96           0.983           0.0  844.788274         NaN  
4             14.16           0.829           0.0  861.327751         NaN  

[5 rows x 62 columns]</code></pre>
</div>
</div>
<div id="5a33bb81" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> data.describe()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>             planid           fips           year      n_nonmiss  \
count  348336.00000  348336.000000  348336.000000  348336.000000   
mean       37.88530   29480.029050    2016.743435       0.924076   
std        67.74584   15608.198231       1.736773       0.995085   
min         1.00000    1001.000000    2014.000000       0.000000   
25%         4.00000   17001.000000    2015.000000       0.000000   
50%        17.00000   29079.000000    2017.000000       0.000000   
75%        49.00000   42081.000000    2018.000000       2.000000   
max       999.00000   56045.000000    2019.000000       4.000000   

       avg_enrollment  sd_enrollment  min_enrollment  max_enrollment  \
count   162365.000000  159046.000000   162365.000000   162365.000000   
mean       478.689529      20.854759      462.455517      495.114674   
std       1836.351888     627.300176     1743.789962     2071.754248   
min         11.000000       0.000000       11.000000       11.000000   
25%         31.000000       0.707107       30.000000       32.000000   
50%         88.500000       2.121320       86.000000       91.000000   
75%        296.000000       5.656854      288.000000      302.000000   
max      80582.000000   90889.776554    60428.000000   159629.000000   

       first_enrollment  last_enrollment  ...  payment_partc   rebate_partc  \
count     162365.000000    162365.000000  ...  312263.000000  312263.000000   
mean         473.741324       482.562473  ...     752.017221      59.457664   
std         1874.477234      1947.646450  ...      75.516622      48.982322   
min           11.000000        11.000000  ...     214.450000       0.000000   
25%           31.000000        32.000000  ...     709.360000      23.230000   
50%           87.000000        90.000000  ...     755.010000      52.480000   
75%          292.000000       299.000000  ...     800.650000      85.630000   
max       158960.000000    159629.000000  ...    1053.100000     461.520000   

            year_reb  payment_partd  directsubsidy_partd  reinsurance_partd  \
count  312263.000000  263581.000000        263581.000000      263581.000000   
mean     2016.789876     106.359987            26.569810          53.254084   
std         1.744654      39.562649             9.045739          25.026521   
min      2014.000000      11.540000             0.010000           0.200000   
25%      2015.000000      81.490000            19.340000          36.340000   
50%      2017.000000     100.660000            25.570000          50.040000   
75%      2018.000000     123.450000            34.060000          65.620000   
max      2019.000000     497.010000            70.170000         335.430000   

       costsharing_partd  riskscore_partd  basic_premium            bid  
count      263581.000000    263581.000000  293042.000000  287693.000000  
mean           26.536092         0.971865       4.031882     778.461432  
std            19.735820         0.125209      21.289034     132.668822  
min             0.000000         0.556000       0.000000     190.571264  
25%            13.820000         0.891000       0.000000     702.531056  
50%            23.050000         0.966000       0.000000     771.801980  
75%            34.060000         1.038000       0.000000     846.642259  
max           226.840000         2.311000     375.600000    1881.786543  

[8 rows x 43 columns]</code></pre>
</div>
</div>
<div id="f1465e95" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>columns_df <span class="op">=</span> pd.DataFrame(data.columns, columns<span class="op">=</span>[<span class="st">'column_name'</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(columns_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>          column_name
0          contractid
1              planid
2                fips
3                year
4           n_nonmiss
..                ...
57  costsharing_partd
58    riskscore_partd
59      basic_premium
60                bid
61        contract_id

[62 rows x 1 columns]</code></pre>
</div>
</div>
<div id="00a8a701" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 1</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"planid_num"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"planid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Make numeric copies</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"planid_num"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"planid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"fips"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"fips"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply assignment filters</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove SNPs</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[data[<span class="st">"snp"</span>] <span class="op">!=</span> <span class="st">"Yes"</span>]</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove 800–899 plans only</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[<span class="op">~</span>data[<span class="st">"planid_num"</span>].between(<span class="dv">800</span>, <span class="dv">899</span>, inclusive<span class="op">=</span><span class="st">"both"</span>)]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove prescription-drug-only plans (PDP-only)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>data<span class="op">=</span> data[data[<span class="st">'partd'</span>] <span class="op">==</span> <span class="st">'Yes'</span>]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep valid counties and years</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[data[<span class="st">"fips"</span>].notna()]</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[data[<span class="st">"year"</span>].between(<span class="dv">2014</span>, <span class="dv">2019</span>)]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop missing plan IDs</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data[data[<span class="st">"planid_num"</span>].notna()].copy()</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Count unique plans per county-year</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>plan_pairs <span class="op">=</span> (</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    data[[<span class="st">"year"</span>, <span class="st">"fips"</span>, <span class="st">"contractid"</span>]]</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    .drop_duplicates()</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>plan_counts <span class="op">=</span> (</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    plan_pairs.groupby([<span class="st">"year"</span>, <span class="st">"fips"</span>])</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"n_plans"</span>)</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Boxplot by year</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>years <span class="op">=</span> <span class="bu">sorted</span>(plan_counts[<span class="st">"year"</span>].unique())</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>data_by_year <span class="op">=</span> [plan_counts.loc[plan_counts[<span class="st">"year"</span>] <span class="op">==</span> y, <span class="st">"n_plans"</span>].values <span class="cf">for</span> y <span class="kw">in</span> years]</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>plt.boxplot(data_by_year, labels<span class="op">=</span>[<span class="bu">str</span>(<span class="bu">int</span>(y)) <span class="cf">for</span> y <span class="kw">in</span> years])</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Year"</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of plans per county"</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of MA plan counts by county (2014–2019)"</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary stats</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> (</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    plan_counts.groupby(<span class="st">"year"</span>)[<span class="st">"n_plans"</span>]</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"count"</span>, <span class="st">"median"</span>, <span class="st">"mean"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>])</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/3870393585.py:45: MatplotlibDeprecationWarning: The 'labels' parameter of boxplot() has been renamed 'tick_labels' since Matplotlib 3.9; support for the old name will be dropped in 3.11.
  plt.boxplot(data_by_year, labels=[str(int(y)) for y in years])</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="HW2-submission1_files/figure-html/cell-7-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>   year  count  median      mean  min  max
0  2014   3070     6.0  7.322801    1   77
1  2015   3072     6.0  7.640951    1   71
2  2016   3072     6.0  7.865234    1   64
3  2017   3064     6.0  7.757833    1   54
4  2018   3066     7.0  8.208089    1   64
5  2019   3056     7.0  8.898233    1   60</code></pre>
</div>
</div>
<section id="between-2014-and-2016-the-number-of-plans-was-too-few.-between-2017-and-2019-the-number-of-plans-was-much-higher-in-my-opinion-at-a" class="level1">
<h1>Between 2014 and 2016, the number of plans was too few. Between 2017 and 2019, the number of plans was much higher, in my opinion at a</h1>
</section>
<section id="sufficient-value.-overall-the-graph-shows-expanding-plan-availability-over-time." class="level1">
<h1>sufficient value. Overall, the graph shows expanding plan availability over time.</h1>
<div id="413cedaa" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 2</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> [<span class="st">"rebate_partc"</span>, <span class="st">"premium"</span>, <span class="st">"premium_partc"</span>, <span class="st">"payment_partc"</span>, <span class="st">"riskscore_partc"</span>, <span class="st">"bid"</span>]:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> c <span class="kw">in</span> data.columns:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        data[c] <span class="op">=</span> pd.to_numeric(data[c], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># compute basic premium + bid </span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"basic_premium_recalc"</span>] <span class="op">=</span> np.where(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">"rebate_partc"</span>] <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    np.where(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">"partd"</span>] <span class="op">==</span> <span class="st">"No"</span>) <span class="op">&amp;</span> data[<span class="st">"premium"</span>].notna() <span class="op">&amp;</span> data[<span class="st">"premium_partc"</span>].isna(),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">"premium"</span>],</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">"premium_partc"</span>]</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># bid:</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"bid_recalc"</span>] <span class="op">=</span> np.nan</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>valid_risk <span class="op">=</span> data[<span class="st">"riskscore_partc"</span>].notna() <span class="op">&amp;</span> (data[<span class="st">"riskscore_partc"</span>] <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>mask1 <span class="op">=</span> valid_risk <span class="op">&amp;</span> (data[<span class="st">"rebate_partc"</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (data[<span class="st">"basic_premium_recalc"</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>data.loc[mask1, <span class="st">"bid_recalc"</span>] <span class="op">=</span> (</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    (data.loc[mask1, <span class="st">"payment_partc"</span>] <span class="op">+</span> data.loc[mask1, <span class="st">"basic_premium_recalc"</span>])</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> data.loc[mask1, <span class="st">"riskscore_partc"</span>]</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>mask2 <span class="op">=</span> valid_risk <span class="op">&amp;</span> ((data[<span class="st">"rebate_partc"</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">|</span> (data[<span class="st">"basic_premium_recalc"</span>] <span class="op">==</span> <span class="dv">0</span>))</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>data.loc[mask2, <span class="st">"bid_recalc"</span>] <span class="op">=</span> (</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    data.loc[mask2, <span class="st">"payment_partc"</span>] <span class="op">/</span> data.loc[mask2, <span class="st">"riskscore_partc"</span>]</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Frequency histograms</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_bid_hist(df, year, bid_col<span class="op">=</span><span class="st">"bid_recalc"</span>, bins<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> df.loc[df[<span class="st">"year"</span>] <span class="op">==</span> year, bid_col].dropna()</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    plt.hist(x, bins<span class="op">=</span>bins)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Distribution of plan bids (</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Bid"</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Count of Plans"</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>plot_bid_hist(data, <span class="dv">2014</span>, bid_col<span class="op">=</span><span class="st">"bid_recalc"</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>plot_bid_hist(data, <span class="dv">2018</span>, bid_col<span class="op">=</span><span class="st">"bid_recalc"</span>, bins<span class="op">=</span><span class="dv">50</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">#summary stats</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> bid_summary(df, year, bid_col<span class="op">=</span><span class="st">"bid_recalc"</span>):</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> df.loc[df[<span class="st">"year"</span>] <span class="op">==</span> year, bid_col].dropna()</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n"</span>: x.shape[<span class="dv">0</span>],</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mean"</span>: x.mean(),</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"median"</span>: x.median(),</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p10"</span>: x.quantile(<span class="fl">0.10</span>),</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p90"</span>: x.quantile(<span class="fl">0.90</span>),</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">"min"</span>: x.<span class="bu">min</span>(),</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max"</span>: x.<span class="bu">max</span>(),</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>bid_stats <span class="op">=</span> pd.DataFrame(</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    [bid_summary(data, <span class="dv">2014</span>), bid_summary(data, <span class="dv">2018</span>)],</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="dv">2014</span>, <span class="dv">2018</span>]</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bid_stats)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="HW2-submission1_files/figure-html/cell-8-output-1.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="HW2-submission1_files/figure-html/cell-8-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            n        mean      median         p10         p90         min  \
2014  29714.0  822.410480  822.668137  666.608247  972.739394  313.924915   
2018  49290.0  752.903695  754.555085  628.234742  871.483942  232.984658   

              max  
2014  1437.740304  
2018  1487.847866  </code></pre>
</div>
</div>
</section>
<section id="how-has-distribution-changed-over-time" class="level1">
<h1>How has distribution changed over time</h1>
</section>
<section id="the-distribution-of-these-plan-bids-shifted-downward-on-average-while-the-overall-number-of-plans-increased." class="level1">
<h1>The distribution of these plan bids shifted downward on average, while the overall number of plans increased.</h1>
<div id="681b16ac" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 3</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"avg_enrollment"</span>] <span class="op">=</span> pd.to_numeric(data[<span class="st">"avg_enrollment"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>data[<span class="st">"avg_enrollment"</span>].notna()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute contract-level enrollment per county-year</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>contractenrollment <span class="op">=</span> (</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    data.groupby([<span class="st">"year"</span>, <span class="st">"fips"</span>, <span class="st">"contractid"</span>])[<span class="st">"avg_enrollment"</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"contract_enroll"</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute total county enrollment</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>countyenroll <span class="op">=</span> (</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    contractenrollment.groupby([<span class="st">"year"</span>, <span class="st">"fips"</span>])[<span class="st">"contract_enroll"</span>]</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"county_total"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>contractenrollment <span class="op">=</span> contractenrollment.merge(</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    countyenroll,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"year"</span>, <span class="st">"fips"</span>],</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute market shares and HHI</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>contractenrollment[<span class="st">"share"</span>] <span class="op">=</span> (</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    contractenrollment[<span class="st">"contract_enroll"</span>]</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> contractenrollment[<span class="st">"county_total"</span>]</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>contractenrollment[<span class="st">"share_sq"</span>] <span class="op">=</span> contractenrollment[<span class="st">"share"</span>] <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>county_hhi <span class="op">=</span> (</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    contractenrollment.groupby([<span class="st">"year"</span>, <span class="st">"fips"</span>])[<span class="st">"share_sq"</span>]</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">sum</span>()</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"hhi"</span>)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Average HHI by year</span></span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>avg_hhi <span class="op">=</span> (</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    county_hhi.groupby(<span class="st">"year"</span>)[<span class="st">"hhi"</span>]</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>     .mean()</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"avg_hhi"</span>)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(avg_hhi)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>plt.plot(avg_hhi[<span class="st">"year"</span>], avg_hhi[<span class="st">"avg_hhi"</span>], marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Average HHI over Time"</span>)</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   year   avg_hhi
0  2014  0.445119
1  2015  0.429463
2  2016  0.427774
3  2017  0.428402
4  2018  0.419009
5  2019  0.392132</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="HW2-submission1_files/figure-html/cell-9-output-2.png" width="662" height="470" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="how-has-the-hhi-changed-over-time" class="level1">
<h1>How has the HHI changed over time</h1>
</section>
<section id="based-on-the-illustration-of-the-graph-we-can-conclude-that-hhi-has-decreased-over-time.-it-was-at-its-highest-in-2014-and-then-had-a-stark-drop-in-2015-continuing-a-small-downward-trend-until-slightly-rising-in-2017-and-then-a-stark-drop-in-the-years-following." class="level1">
<h1>Based on the illustration of the graph, we can conclude that HHI has decreased over time. It was at its highest in 2014 and then had a stark drop in 2015, continuing a small downward trend until slightly rising in 2017, and then a stark drop in the years following.</h1>
<div id="7cabb456" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby(<span class="st">"year"</span>)[[<span class="st">"avg_enrolled"</span>, <span class="st">"avg_eligibles"</span>]].count())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      avg_enrolled  avg_eligibles
year                             
2014             0              0
2015             0              0
2016             0              0
2017         44861          44922
2018         54167          54215
2019         63921          63964</code></pre>
</div>
</div>
<div id="8cb4c3a8" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.columns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment',
       'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment',
       'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd',
       'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name',
       'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen',
       'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles',
       'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled',
       'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled',
       'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium',
       'premium_partc', 'premium_partd_basic', 'premium_partd_supp',
       'premium_partd_total', 'partd_deductible', 'year_land',
       'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb',
       'payment_partd', 'directsubsidy_partd', 'reinsurance_partd',
       'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid',
       'contract_id', 'planid_num', 'basic_premium_recalc', 'bid_recalc'],
      dtype='object')</code></pre>
</div>
</div>
<div id="67f491eb" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data[<span class="st">"year_pen"</span>].value_counts(dropna<span class="op">=</span><span class="va">False</span>).sort_index())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>year_pen
2017.0     44922
2018.0     54215
2019.0     63964
NaN       125488
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="f25974a9" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.loc[data[<span class="st">"year"</span>].between(<span class="dv">2014</span>, <span class="dv">2016</span>), </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>               [<span class="st">"year"</span>, <span class="st">"year_pen"</span>, <span class="st">"avg_enrolled"</span>, <span class="st">"avg_eligibles"</span>]].head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   year  year_pen  avg_enrolled  avg_eligibles
0  2014       NaN           NaN            NaN
1  2014       NaN           NaN            NaN
2  2014       NaN           NaN            NaN
3  2014       NaN           NaN            NaN
4  2014       NaN           NaN            NaN
5  2014       NaN           NaN            NaN
6  2014       NaN           NaN            NaN
7  2014       NaN           NaN            NaN
8  2014       NaN           NaN            NaN
9  2014       NaN           NaN            NaN</code></pre>
</div>
</div>
<div id="7a873acc" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(os.listdir())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['data-2018.ipynb', 'data-2014.ipynb', 'data-2015.ipynb', 'HW2-submission1.quarto_ipynb', 'HW2-submission1_files', 'data-2017.ipynb', 'data-2019.ipynb', 'HW2-submission1.ipynb', '.git', 'master data document.ipynb', '__pycache__', 'ReadME.md', 'data-2016.ipynb', 'functions.py', 'HW2-submission1.qmd', '.ipynb_checkpoints']</code></pre>
</div>
</div>
<div id="fcb625cd" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Years in plan data:"</span>, <span class="bu">sorted</span>(data[<span class="st">"year"</span>].dropna().unique()))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Years in penetration data:"</span>, <span class="bu">sorted</span>(data[<span class="st">"year_pen"</span>].dropna().unique()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Years in plan data: [np.int64(2014), np.int64(2015), np.int64(2016), np.int64(2017), np.int64(2018), np.int64(2019)]
Years in penetration data: [np.float64(2017.0), np.float64(2018.0), np.float64(2019.0)]</code></pre>
</div>
</div>
<div id="1622af8a" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.groupby(<span class="st">"year_pen"</span>)[[<span class="st">"avg_enrolled"</span>, <span class="st">"avg_eligibles"</span>]].count())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>          avg_enrolled  avg_eligibles
year_pen                             
2017.0           44861          44922
2018.0           54167          54215
2019.0           63921          63964</code></pre>
</div>
</div>
<div id="99185800" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 4 </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>pen <span class="op">=</span> data.loc[</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">"year"</span>].between(<span class="dv">2014</span>, <span class="dv">2019</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;</span> data[<span class="st">"fips"</span>].notna()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;</span> data[<span class="st">"avg_enrolled"</span>].notna()</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;</span> data[<span class="st">"avg_eligibles"</span>].notna()</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&amp;</span> (data[<span class="st">"avg_eligibles"</span>] <span class="op">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"year"</span>, <span class="st">"fips"</span>, <span class="st">"avg_enrolled"</span>, <span class="st">"avg_eligibles"</span>]</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>pen_county <span class="op">=</span> (</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    pen.groupby([<span class="st">"year"</span>, <span class="st">"fips"</span>], as_index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>       .agg({</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>           <span class="st">"avg_enrolled"</span>: <span class="st">"first"</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>           <span class="st">"avg_eligibles"</span>: <span class="st">"first"</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>       })</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute MA share</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>pen_county[<span class="st">"ma_share"</span>] <span class="op">=</span> (</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    pen_county[<span class="st">"avg_enrolled"</span>] <span class="op">/</span> pen_county[<span class="st">"avg_eligibles"</span>]</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Average across counties</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>ma_share_year <span class="op">=</span> (</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    pen_county.groupby(<span class="st">"year"</span>, as_index<span class="op">=</span><span class="va">False</span>)[<span class="st">"ma_share"</span>]</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"ma_share"</span>: <span class="st">"avg_ma_share"</span>})</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ma_share_year)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>plt.plot(ma_share_year[<span class="st">"year"</span>], ma_share_year[<span class="st">"avg_ma_share"</span>], marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Year"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Average MA share"</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Average Medicare Advantage penetration (2014–2019)"</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   year  avg_ma_share
0  2017      0.242952
1  2018      0.250958
2  2019      0.280523</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="HW2-submission1_files/figure-html/cell-17-output-2.png" width="660" height="470" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="has-medicare-advantage-increased-or-decreased" class="level1">
<h1>Has Medicare Advantage increased or decreased?</h1>
</section>
<section id="medicare-advantage-has-increased-and-become-more-popular-over-time." class="level1">
<h1>Medicare Advantage has increased and become more popular over time.</h1>
<div id="b4151c8f" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 5</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Keep only 2018 data</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>data_2018 <span class="op">=</span> data[data[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2018</span>].copy()</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric types</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>data_2018[<span class="st">"bid"</span>] <span class="op">=</span> pd.to_numeric(data_2018[<span class="st">"bid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>data_2018[<span class="st">"avg_enrollment"</span>] <span class="op">=</span> pd.to_numeric(data_2018[<span class="st">"avg_enrollment"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing values</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>data_2018 <span class="op">=</span> data_2018.dropna(subset<span class="op">=</span>[<span class="st">"bid"</span>, <span class="st">"avg_enrollment"</span>, <span class="st">"fips"</span>])</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Compute plan market shares within county</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>data_2018[<span class="st">"county_total_enrollment"</span>] <span class="op">=</span> (</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    data_2018.groupby(<span class="st">"fips"</span>)[<span class="st">"avg_enrollment"</span>].transform(<span class="st">"sum"</span>)</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>data_2018[<span class="st">"market_share"</span>] <span class="op">=</span> (</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    data_2018[<span class="st">"avg_enrollment"</span>] <span class="op">/</span> data_2018[<span class="st">"county_total_enrollment"</span>]</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Compute HHI per county</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>hhi_2018 <span class="op">=</span> (</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    data_2018.groupby(<span class="st">"fips"</span>)[<span class="st">"market_share"</span>]</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"hhi"</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Determine percentile cutoffs</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>p33 <span class="op">=</span> hhi_2018[<span class="st">"hhi"</span>].quantile(<span class="fl">0.33</span>)</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>p66 <span class="op">=</span> hhi_2018[<span class="st">"hhi"</span>].quantile(<span class="fl">0.66</span>)</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"33rd percentile HHI:"</span>, p33)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"66th percentile HHI:"</span>, p66)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Classify markets</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_market(hhi):</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> hhi <span class="op">&lt;=</span> p33:</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"competitive"</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> hhi <span class="op">&gt;=</span> p66:</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"uncompetitive"</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"middle"</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>hhi_2018[<span class="st">"market_type"</span>] <span class="op">=</span> hhi_2018[<span class="st">"hhi"</span>].<span class="bu">apply</span>(classify_market)</span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Merge classification back to plan data</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>data_2018 <span class="op">=</span> data_2018.merge(hhi_2018, on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Compare average bids</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>avg_bid <span class="op">=</span> (</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    data_2018[data_2018[<span class="st">"market_type"</span>].isin([<span class="st">"competitive"</span>, <span class="st">"uncompetitive"</span>])]</span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"market_type"</span>)[<span class="st">"bid"</span>]</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>display(avg_bid)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>33rd percentile HHI: 0.25060491376218474
66th percentile HHI: 0.4065883868751973</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">market_type</th>
<th data-quarto-table-cell-role="th">bid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>competitive</td>
<td>753.998656</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>uncompetitive</td>
<td>761.411054</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="517481ac" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.columns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment',
       'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment',
       'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd',
       'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name',
       'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen',
       'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles',
       'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled',
       'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled',
       'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium',
       'premium_partc', 'premium_partd_basic', 'premium_partd_supp',
       'premium_partd_total', 'partd_deductible', 'year_land',
       'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb',
       'payment_partd', 'directsubsidy_partd', 'reinsurance_partd',
       'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid',
       'contract_id'],
      dtype='object')</code></pre>
</div>
</div>
<div id="980b184e" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Question 6</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to 2018</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> data.copy()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018[df_2018[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2018</span>].copy()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure numeric</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"bid"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"bid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"avg_enrolled"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"avg_enrolled"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"payment_partc"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"payment_partc"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop missing values</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018[df_2018[<span class="st">"bid"</span>].notna() <span class="op">&amp;</span> df_2018[<span class="st">"avg_enrolled"</span>].notna() <span class="op">&amp;</span> df_2018[<span class="st">"payment_partc"</span>].notna()].copy()</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute HHI for each county ---</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Define firm</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"firm"</span>] <span class="op">=</span> df_2018[<span class="st">"parent_org"</span>].fillna(df_2018[<span class="st">"org_name"</span>]).astype(<span class="bu">str</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Market totals</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>market_total <span class="op">=</span> df_2018.groupby(<span class="st">"fips"</span>)[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>().rename(<span class="st">"mkt_enroll"</span>).reset_index()</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> df_2018.groupby([<span class="st">"fips"</span>, <span class="st">"firm"</span>])[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>().rename(<span class="st">"firm_enroll"</span>).reset_index()</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> firm_total.merge(market_total, on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>firm_total[<span class="st">"share"</span>] <span class="op">=</span> firm_total[<span class="st">"firm_enroll"</span>] <span class="op">/</span> firm_total[<span class="st">"mkt_enroll"</span>]</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co"># HHI per market</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> firm_total.groupby(<span class="st">"fips"</span>)[<span class="st">"share"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()).reset_index(name<span class="op">=</span><span class="st">"hhi"</span>)</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Define competitive/uncompetitive</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>p33 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>p66 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&gt;=</span> p66, <span class="dv">1</span>,</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>                                 np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&lt;=</span> p33, <span class="dv">0</span>, np.nan))</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only competitive/uncompetitive</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> hhi_market[hhi_market[<span class="st">"treated"</span>].notna()].copy()</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> hhi_market[<span class="st">"treated"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge back to df_2018</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018.merge(hhi_market[[<span class="st">"fips"</span>,<span class="st">"hhi"</span>,<span class="st">"treated"</span>]], on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="co"># --- FFS quartiles ---</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"ffs_q"</span>] <span class="op">=</span> pd.qcut(df_2018[<span class="st">"payment_partc"</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]:</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>    df_2018[<span class="ss">f"ffs_q</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (df_2018[<span class="st">"ffs_q"</span>].astype(<span class="bu">int</span>) <span class="op">==</span> q).astype(<span class="bu">int</span>)</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Average bid table ---</span></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>    df_2018.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>]</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>           .mean()</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>           .pivot(index<span class="op">=</span><span class="st">"ffs_q"</span>, columns<span class="op">=</span><span class="st">"treated"</span>, values<span class="op">=</span><span class="st">"bid"</span>)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"avg_bid_competitive"</span>, <span class="dv">1</span>: <span class="st">"avg_bid_uncompetitive"</span>})</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Add counts</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> (</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>    df_2018.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>]</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>           .size()</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>           .reset_index(name<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>           .pivot(index<span class="op">=</span><span class="st">"ffs_q"</span>, columns<span class="op">=</span><span class="st">"treated"</span>, values<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"n_competitive"</span>, <span class="dv">1</span>: <span class="st">"n_uncompetitive"</span>})</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge final table</span></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>out_2018 <span class="op">=</span> table.merge(counts, on<span class="op">=</span><span class="st">"ffs_q"</span>, how<span class="op">=</span><span class="st">"left"</span>).sort_values(<span class="st">"ffs_q"</span>)</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>out_2018[[<span class="st">"avg_bid_competitive"</span>,<span class="st">"avg_bid_uncompetitive"</span>]] <span class="op">=</span> out_2018[[<span class="st">"avg_bid_competitive"</span>,<span class="st">"avg_bid_uncompetitive"</span>]].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"HHI cutoffs for 2018: 33rd pct = </span><span class="sc">{</span>p33<span class="sc">:.4f}</span><span class="ss">, 66th pct = </span><span class="sc">{</span>p66<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>display(out_2018)<span class="co"># Filter to 2018</span></span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> data.copy()</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018[df_2018[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2018</span>].copy()</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure numeric</span></span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"bid"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"bid"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"avg_enrolled"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"avg_enrolled"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"payment_partc"</span>] <span class="op">=</span> pd.to_numeric(df_2018[<span class="st">"payment_partc"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop missing values</span></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018[df_2018[<span class="st">"bid"</span>].notna() <span class="op">&amp;</span> df_2018[<span class="st">"avg_enrolled"</span>].notna() <span class="op">&amp;</span> df_2018[<span class="st">"payment_partc"</span>].notna()].copy()</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute HHI for each county ---</span></span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a><span class="co"># Define firm</span></span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"firm"</span>] <span class="op">=</span> df_2018[<span class="st">"parent_org"</span>].fillna(df_2018[<span class="st">"org_name"</span>]).astype(<span class="bu">str</span>)</span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Market totals</span></span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a>market_total <span class="op">=</span> df_2018.groupby(<span class="st">"fips"</span>)[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>().rename(<span class="st">"mkt_enroll"</span>).reset_index()</span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> df_2018.groupby([<span class="st">"fips"</span>, <span class="st">"firm"</span>])[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>().rename(<span class="st">"firm_enroll"</span>).reset_index()</span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> firm_total.merge(market_total, on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a>firm_total[<span class="st">"share"</span>] <span class="op">=</span> firm_total[<span class="st">"firm_enroll"</span>] <span class="op">/</span> firm_total[<span class="st">"mkt_enroll"</span>]</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a><span class="co"># HHI per market</span></span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> firm_total.groupby(<span class="st">"fips"</span>)[<span class="st">"share"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()).reset_index(name<span class="op">=</span><span class="st">"hhi"</span>)</span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Define competitive/uncompetitive</span></span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>p33 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>p66 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&gt;=</span> p66, <span class="dv">1</span>,</span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>                                 np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&lt;=</span> p33, <span class="dv">0</span>, np.nan))</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only competitive/uncompetitive</span></span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> hhi_market[hhi_market[<span class="st">"treated"</span>].notna()].copy()</span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> hhi_market[<span class="st">"treated"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge back to df_2018</span></span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a>df_2018 <span class="op">=</span> df_2018.merge(hhi_market[[<span class="st">"fips"</span>,<span class="st">"hhi"</span>,<span class="st">"treated"</span>]], on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a><span class="co"># --- FFS quartiles ---</span></span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a>df_2018[<span class="st">"ffs_q"</span>] <span class="op">=</span> pd.qcut(df_2018[<span class="st">"payment_partc"</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])</span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>]:</span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a>    df_2018[<span class="ss">f"ffs_q</span><span class="sc">{</span>q<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (df_2018[<span class="st">"ffs_q"</span>].astype(<span class="bu">int</span>) <span class="op">==</span> q).astype(<span class="bu">int</span>)</span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Average bid table ---</span></span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a>table <span class="op">=</span> (</span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a>    df_2018.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>]</span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a>           .mean()</span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-120"><a href="#cb37-120" aria-hidden="true" tabindex="-1"></a>           .pivot(index<span class="op">=</span><span class="st">"ffs_q"</span>, columns<span class="op">=</span><span class="st">"treated"</span>, values<span class="op">=</span><span class="st">"bid"</span>)</span>
<span id="cb37-121"><a href="#cb37-121" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"avg_bid_competitive"</span>, <span class="dv">1</span>: <span class="st">"avg_bid_uncompetitive"</span>})</span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Add counts</span></span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> (</span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a>    df_2018.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>]</span>
<span id="cb37-128"><a href="#cb37-128" aria-hidden="true" tabindex="-1"></a>           .size()</span>
<span id="cb37-129"><a href="#cb37-129" aria-hidden="true" tabindex="-1"></a>           .reset_index(name<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a>           .pivot(index<span class="op">=</span><span class="st">"ffs_q"</span>, columns<span class="op">=</span><span class="st">"treated"</span>, values<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a>           .rename(columns<span class="op">=</span>{<span class="dv">0</span>: <span class="st">"n_competitive"</span>, <span class="dv">1</span>: <span class="st">"n_uncompetitive"</span>})</span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a>           .reset_index()</span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge final table</span></span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a>out_2018 <span class="op">=</span> table.merge(counts, on<span class="op">=</span><span class="st">"ffs_q"</span>, how<span class="op">=</span><span class="st">"left"</span>).sort_values(<span class="st">"ffs_q"</span>)</span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a>out_2018[[<span class="st">"avg_bid_competitive"</span>,<span class="st">"avg_bid_uncompetitive"</span>]] <span class="op">=</span> out_2018[[<span class="st">"avg_bid_competitive"</span>,<span class="st">"avg_bid_uncompetitive"</span>]].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Display</span></span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"HHI cutoffs for 2018: 33rd pct = </span><span class="sc">{</span>p33<span class="sc">:.4f}</span><span class="ss">, 66th pct = </span><span class="sc">{</span>p66<span class="sc">:.4f}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>display(out_2018)</span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-143"><a href="#cb37-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Display nicely</span></span>
<span id="cb37-144"><a href="#cb37-144" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a>display()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>HHI cutoffs for 2018: 33rd pct = 0.2819, 66th pct = 0.4286
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/137646023.py:48: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df_2018.groupby(["ffs_q", "treated"])["bid"]
/tmp/ipykernel_1471476/137646023.py:58: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df_2018.groupby(["ffs_q", "treated"])["bid"]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">treated</th>
<th data-quarto-table-cell-role="th">ffs_q</th>
<th data-quarto-table-cell-role="th">avg_bid_competitive</th>
<th data-quarto-table-cell-role="th">avg_bid_uncompetitive</th>
<th data-quarto-table-cell-role="th">n_competitive</th>
<th data-quarto-table-cell-role="th">n_uncompetitive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>673.33</td>
<td>669.25</td>
<td>8196</td>
<td>687</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>762.84</td>
<td>755.93</td>
<td>7699</td>
<td>1199</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>770.53</td>
<td>771.12</td>
<td>6869</td>
<td>1997</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>806.05</td>
<td>784.78</td>
<td>6860</td>
<td>2004</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>HHI cutoffs for 2018: 33rd pct = 0.2819, 66th pct = 0.4286
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/137646023.py:117: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df_2018.groupby(["ffs_q", "treated"])["bid"]
/tmp/ipykernel_1471476/137646023.py:127: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df_2018.groupby(["ffs_q", "treated"])["bid"]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">treated</th>
<th data-quarto-table-cell-role="th">ffs_q</th>
<th data-quarto-table-cell-role="th">avg_bid_competitive</th>
<th data-quarto-table-cell-role="th">avg_bid_uncompetitive</th>
<th data-quarto-table-cell-role="th">n_competitive</th>
<th data-quarto-table-cell-role="th">n_uncompetitive</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>673.33</td>
<td>669.25</td>
<td>8196</td>
<td>687</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>762.84</td>
<td>755.93</td>
<td>7699</td>
<td>1199</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>770.53</td>
<td>771.12</td>
<td>6869</td>
<td>1997</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>806.05</td>
<td>784.78</td>
<td>6860</td>
<td>2004</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="c929988b" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute total enrollment per firm in each market</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"firm"</span>] <span class="op">=</span> df[<span class="st">"parent_org"</span>].fillna(df[<span class="st">"org_name"</span>]).astype(<span class="bu">str</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> (</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"fips"</span>, <span class="st">"year"</span>, <span class="st">"firm"</span>])[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>()</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>      .rename(<span class="st">"firm_enroll"</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>      .reset_index()</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>market_total <span class="op">=</span> firm_total.groupby([<span class="st">"fips"</span>, <span class="st">"year"</span>])[<span class="st">"firm_enroll"</span>].<span class="bu">sum</span>().rename(<span class="st">"mkt_enroll"</span>).reset_index()</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> firm_total.merge(market_total, on<span class="op">=</span>[<span class="st">"fips"</span>, <span class="st">"year"</span>])</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>firm_total[<span class="st">"share"</span>] <span class="op">=</span> firm_total[<span class="st">"firm_enroll"</span>] <span class="op">/</span> firm_total[<span class="st">"mkt_enroll"</span>]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a><span class="co"># HHI per market</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> (</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    firm_total.assign(share_sq<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"share"</span>] <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>             .groupby([<span class="st">"fips"</span>, <span class="st">"year"</span>])[<span class="st">"share_sq"</span>]</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>             .<span class="bu">sum</span>()</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>             .rename(<span class="st">"hhi"</span>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>             .reset_index()</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Define treated vs control</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>p33 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>p66 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&gt;=</span> p66, <span class="dv">1</span>,</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>                                 np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&lt;=</span> p33, <span class="dv">0</span>, np.nan))</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only competitive/uncompetitive markets</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> hhi_market[hhi_market[<span class="st">"treated"</span>].notna()].copy()</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> hhi_market[<span class="st">"treated"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge back to df</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df.merge(hhi_market[[<span class="st">"fips"</span>, <span class="st">"year"</span>, <span class="st">"treated"</span>]], on<span class="op">=</span>[<span class="st">"fips"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6c384732" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that the treated column exists</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.columns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment',
       'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment',
       'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd',
       'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name',
       'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen',
       'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles',
       'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled',
       'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled',
       'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium',
       'premium_partc', 'premium_partd_basic', 'premium_partd_supp',
       'premium_partd_total', 'partd_deductible', 'year_land',
       'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb',
       'payment_partd', 'directsubsidy_partd', 'reinsurance_partd',
       'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid',
       'contract_id', 'firm', 'treated'],
      dtype='object')</code></pre>
</div>
</div>
<div id="83795c62" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df[df[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2018</span>].copy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6c60d4c9" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.merge(</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    hhi_market[[<span class="st">"fips"</span>, <span class="st">"hhi"</span>, <span class="st">"treated"</span>]],</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"fips"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d4244415" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"After merge columns:"</span>, df2018.columns.tolist())</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Does treated exist?"</span>, <span class="st">"treated"</span> <span class="kw">in</span> df2018.columns)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Shape:"</span>, df2018.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>After merge columns: ['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment', 'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment', 'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd', 'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name', 'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen', 'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles', 'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled', 'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled', 'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium', 'premium_partc', 'premium_partd_basic', 'premium_partd_supp', 'premium_partd_total', 'partd_deductible', 'year_land', 'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb', 'payment_partd', 'directsubsidy_partd', 'reinsurance_partd', 'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid', 'contract_id', 'firm', 'treated_x', 'hhi', 'treated_y']
Does treated exist? False
Shape: (168843, 66)</code></pre>
</div>
</div>
<div id="21c4a8b8" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.drop(columns<span class="op">=</span>[c <span class="cf">for</span> c <span class="kw">in</span> df2018.columns <span class="cf">if</span> <span class="st">"treated"</span> <span class="kw">in</span> c <span class="kw">or</span> <span class="st">"hhi"</span> <span class="kw">in</span> c],</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                     errors<span class="op">=</span><span class="st">"ignore"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b2853656" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.merge(</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    hhi_market[[<span class="st">"fips"</span>, <span class="st">"hhi"</span>, <span class="st">"treated"</span>]],</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"fips"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3995b695" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>([c <span class="cf">for</span> c <span class="kw">in</span> df2018.columns <span class="cf">if</span> <span class="st">"treated"</span> <span class="kw">in</span> c])</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>([c <span class="cf">for</span> c <span class="kw">in</span> df2018.columns <span class="cf">if</span> <span class="st">"hhi"</span> <span class="kw">in</span> c])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['treated']
['hhi']</code></pre>
</div>
</div>
<div id="1513481f" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018.columns)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment',
       'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment',
       'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd',
       'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name',
       'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen',
       'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles',
       'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled',
       'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled',
       'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium',
       'premium_partc', 'premium_partd_basic', 'premium_partd_supp',
       'premium_partd_total', 'partd_deductible', 'year_land',
       'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb',
       'payment_partd', 'directsubsidy_partd', 'reinsurance_partd',
       'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid',
       'contract_id', 'firm', 'hhi', 'treated'],
      dtype='object')</code></pre>
</div>
</div>
<div id="5f7d671f" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[[<span class="st">'fips'</span>,<span class="st">'year'</span>,<span class="st">'hhi'</span>,<span class="st">'treated'</span>]].head())</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[<span class="st">'treated'</span>].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      fips  year       hhi  treated
0  15007.0  2018  0.000000        0
1  15007.0  2018  0.000000        0
2  15007.0  2018  0.000000        0
3  15007.0  2018  0.333333        1
4  15007.0  2018  0.376543        1
treated
0    507734
1    428295
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="846c7850" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create avg_ffscost using basic_premium if avg_ffscost doesn't exist</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"avg_ffscost"</span>] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    df2018.get(<span class="st">"avg_ffscost"</span>, df2018.get(<span class="st">"basic_premium"</span>)), errors<span class="op">=</span><span class="st">"coerce"</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop missing or zero costs</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018[df2018[<span class="st">"avg_ffscost"</span>].notna() <span class="op">&amp;</span> (df2018[<span class="st">"avg_ffscost"</span>] <span class="op">&gt;</span> <span class="dv">0</span>)].copy()</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create quartiles safely, allowing duplicates</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"ffs_q"</span>] <span class="op">=</span> pd.qcut(df2018[<span class="st">"avg_ffscost"</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick check</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[[<span class="st">"fips"</span>,<span class="st">"year"</span>,<span class="st">"avg_ffscost"</span>,<span class="st">"ffs_q"</span>]].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         fips  year  avg_ffscost ffs_q
22104  8003.0  2018         85.0     3
22105  8003.0  2018         85.0     3
22106  8003.0  2018         85.0     3
22107  8003.0  2018         85.0     3
22108  8003.0  2018         85.0     3</code></pre>
</div>
</div>
<div id="48850c98" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Keep only 2018 ---</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df[df[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2018</span>].copy()</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Ensure numeric ---</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"avg_enrolled"</span>] <span class="op">=</span> pd.to_numeric(df2018[<span class="st">"avg_enrolled"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018[df2018[<span class="st">"avg_enrolled"</span>].notna()].copy()</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Identify firm ---</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"firm"</span>] <span class="op">=</span> df2018[<span class="st">"parent_org"</span>].fillna(df2018[<span class="st">"org_name"</span>]).astype(<span class="bu">str</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute market total enrollment by county ---</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>market_total <span class="op">=</span> df2018.groupby(<span class="st">"fips"</span>)[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>().rename(<span class="st">"mkt_enroll"</span>).reset_index()</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute firm enrollment share ---</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>firm_total <span class="op">=</span> (</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    df2018.groupby([<span class="st">"fips"</span>, <span class="st">"firm"</span>])[<span class="st">"avg_enrolled"</span>].<span class="bu">sum</span>()</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    .rename(<span class="st">"firm_enroll"</span>)</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    .merge(market_total, on<span class="op">=</span><span class="st">"fips"</span>)</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>firm_total[<span class="st">"share"</span>] <span class="op">=</span> firm_total[<span class="st">"firm_enroll"</span>] <span class="op">/</span> firm_total[<span class="st">"mkt_enroll"</span>]</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Compute HHI per market ---</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>hhi_market <span class="op">=</span> (</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>    firm_total.groupby(<span class="st">"fips"</span>)[<span class="st">"share"</span>]</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: (x<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"hhi"</span>)</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assign treated (high HHI = uncompetitive) ---</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>p33 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">1</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>p66 <span class="op">=</span> hhi_market[<span class="st">"hhi"</span>].quantile(<span class="dv">2</span><span class="op">/</span><span class="dv">3</span>)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a>hhi_market[<span class="st">"treated"</span>] <span class="op">=</span> np.where(</span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a>    hhi_market[<span class="st">"hhi"</span>] <span class="op">&gt;=</span> p66, <span class="dv">1</span>,</span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>    np.where(hhi_market[<span class="st">"hhi"</span>] <span class="op">&lt;=</span> p33, <span class="dv">0</span>, np.nan)</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop old columns in df2018 to prevent duplicates </span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.drop(columns<span class="op">=</span>[c <span class="cf">for</span> c <span class="kw">in</span> df2018.columns <span class="cf">if</span> c <span class="kw">in</span> [<span class="st">"hhi"</span>,<span class="st">"treated"</span>]], errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge HHI and treated into df2018</span></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.merge(</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>    hhi_market[[<span class="st">"fips"</span>,<span class="st">"hhi"</span>,<span class="st">"treated"</span>]],</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"fips"</span>,</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop middle tercile markets (where treated is NaN)</span></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018[df2018[<span class="st">"treated"</span>].notna()].copy()</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Now treated is only 0 or 1</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"treated"</span>] <span class="op">=</span> df2018[<span class="st">"treated"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[<span class="st">"treated"</span>].value_counts())</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute avg_ffscost using basic_premium</span></span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"avg_ffscost"</span>] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>    df2018.get(<span class="st">"avg_ffscost"</span>, df2018.get(<span class="st">"basic_premium"</span>)), errors<span class="op">=</span><span class="st">"coerce"</span></span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018[df2018[<span class="st">"avg_ffscost"</span>].notna() <span class="op">&amp;</span> (df2018[<span class="st">"avg_ffscost"</span>] <span class="op">&gt;</span> <span class="dv">0</span>)].copy()</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Create quartiles</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"ffs_q"</span>] <span class="op">=</span> pd.qcut(df2018[<span class="st">"avg_ffscost"</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick check</span></span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[[<span class="st">"fips"</span>,<span class="st">"year"</span>,<span class="st">"hhi"</span>,<span class="st">"treated"</span>,<span class="st">"avg_ffscost"</span>,<span class="st">"ffs_q"</span>]].head())</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[<span class="st">"treated"</span>].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>treated
0    15918
1     5528
Name: count, dtype: int64
       fips  year       hhi  treated  avg_ffscost ffs_q
778  8007.0  2018  0.603306        1         85.0     3
780  8015.0  2018  0.302469        0         85.0     3
781  8017.0  2018  1.000000        1         85.0     3
784  8023.0  2018  0.328720        0         85.0     3
788  8033.0  2018  1.000000        1         85.0     3
treated
0    920
1    878
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="1e9d9a3e" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">"bid"</span>].describe()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre><code>count    1007.000000
mean      806.797811
std        69.136985
min       580.897522
25%       773.350384
50%       792.000000
75%       845.608551
max      1272.011923
Name: bid, dtype: float64</code></pre>
</div>
</div>
<div id="0c8436dc" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> <span class="st">"bid"</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="st">"treated"</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> <span class="st">"ffs_q"</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only the columns needed for Q7</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018[[Y, T, Q]].dropna().copy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e253aded" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018_q7[df2018_q7[T].isin([<span class="dv">0</span>, <span class="dv">1</span>])].copy()</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df2018_q7[T] <span class="op">=</span> df2018_q7[T].astype(<span class="bu">int</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>df2018_q7[Q] <span class="op">=</span> df2018_q7[Q].astype(<span class="bu">int</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="143dc54d" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018_q7[T].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>treated
0    542
1    465
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="60c301a4" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df2018_q7_clean <span class="op">=</span> df2018[df2018[<span class="st">"treated"</span>].isin([<span class="dv">0</span>,<span class="dv">1</span>])].copy()</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>df2018_q7_clean.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>].mean().unstack()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/936541308.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df2018_q7_clean.groupby(["ffs_q", "treated"])["bid"].mean().unstack()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="125">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">treated</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ffs_q</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>795.157360</td>
<td>773.741967</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>798.621197</td>
<td>827.004689</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>834.451390</td>
<td>814.323749</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>827.674702</td>
<td>773.495283</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="9588c8fc" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df2018[T] <span class="op">=</span> df2018[T].astype(<span class="bu">int</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018_q7[T].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>treated
0    542
1    465
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="39623291" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only treated = 0 or 1 (remove middle tercile)</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018[[Y, T, Q]].dropna().copy()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018_q7[df2018_q7[T].isin([<span class="dv">0</span>,<span class="dv">1</span>])].copy()</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check counts to confirm</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018_q7[T].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>treated
0    542
1    465
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="fff2a8ab" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df2018.groupby(<span class="st">"treated"</span>)[<span class="st">"hhi"</span>].mean()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>df2018.groupby(<span class="st">"treated"</span>)[<span class="st">"bid"</span>].mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>treated
0    809.203476
1    803.993788
Name: bid, dtype: float64</code></pre>
</div>
</div>
<div id="1dcdab72" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> <span class="st">"bid"</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="st">"treated"</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> <span class="st">"ffs_q"</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by quartile</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df2018_q7.groupby(Q)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Quartile weights</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>p_q <span class="op">=</span> g.size() <span class="op">/</span> <span class="bu">len</span>(df2018_q7)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Mean outcomes by treatment within quartile</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>mu1_q <span class="op">=</span> g.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.loc[x[T]<span class="op">==</span><span class="dv">1</span>, Y].mean())</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>mu0_q <span class="op">=</span> g.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.loc[x[T]<span class="op">==</span><span class="dv">0</span>, Y].mean())</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Build stratification table</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>strat_table <span class="op">=</span> pd.DataFrame({</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_q"</span>: p_q,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu1_q"</span>: mu1_q,</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu0_q"</span>: mu0_q</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Difference (treated - control)</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>strat_table[<span class="st">"diff"</span>] <span class="op">=</span> strat_table[<span class="st">"mu1_q"</span>] <span class="op">-</span> strat_table[<span class="st">"mu0_q"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/4083448761.py:6: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  g = df2018_q7.groupby(Q)
/tmp/ipykernel_1471476/4083448761.py:12: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  mu1_q = g.apply(lambda x: x.loc[x[T]==1, Y].mean())
/tmp/ipykernel_1471476/4083448761.py:13: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  mu0_q = g.apply(lambda x: x.loc[x[T]==0, Y].mean())</code></pre>
</div>
</div>
<div id="f26d3559" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>strat_table[[<span class="st">"p_q"</span>,<span class="st">"mu1_q"</span>,<span class="st">"mu0_q"</span>,<span class="st">"diff"</span>]]</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>(<span class="bu">sum</span>(strat_table[<span class="st">"p_q"</span>] <span class="op">*</span> strat_table[<span class="st">"diff"</span>]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre><code>-10.959121690831587</code></pre>
</div>
</div>
<div id="6f2aa078" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>df2018.groupby(<span class="st">"treated"</span>)[<span class="st">"hhi"</span>].describe()</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>df2018.groupby([<span class="st">"ffs_q"</span>, <span class="st">"treated"</span>])[<span class="st">"bid"</span>].mean().unstack()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/1986704175.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  df2018.groupby(["ffs_q", "treated"])["bid"].mean().unstack()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="131">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">treated</th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ffs_q</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>795.157360</td>
<td>773.741967</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>798.621197</td>
<td>827.004689</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>834.451390</td>
<td>814.323749</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>827.674702</td>
<td>773.495283</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="ef6d95f8" class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018.columns.tolist())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment', 'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment', 'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd', 'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name', 'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen', 'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles', 'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled', 'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled', 'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium', 'premium_partc', 'premium_partd_basic', 'premium_partd_supp', 'premium_partd_total', 'partd_deductible', 'year_land', 'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb', 'payment_partd', 'directsubsidy_partd', 'reinsurance_partd', 'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid', 'contract_id', 'firm', 'hhi', 'treated', 'avg_ffscost', 'ffs_q']</code></pre>
</div>
</div>
<div id="ec358cf2" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop old HHI/treated columns if they exist</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.drop(columns<span class="op">=</span>[c <span class="cf">for</span> c <span class="kw">in</span> df2018.columns <span class="cf">if</span> <span class="st">"hhi"</span> <span class="kw">in</span> c <span class="kw">or</span> <span class="st">"treated"</span> <span class="kw">in</span> c], errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge fresh HHI and treated</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018.merge(hhi_market[[<span class="st">"fips"</span>, <span class="st">"hhi"</span>, <span class="st">"treated"</span>]], on<span class="op">=</span><span class="st">"fips"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Sanity check</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[[<span class="st">"fips"</span>, <span class="st">"hhi"</span>, <span class="st">"treated"</span>]].drop_duplicates().sort_values(<span class="st">"hhi"</span>).head(<span class="dv">10</span>))</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018[<span class="st">"treated"</span>].value_counts())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>         fips       hhi  treated
1747   1079.0  0.254438      0.0
1780  47103.0  0.254438      0.0
1330  40143.0  0.254501      0.0
198   51600.0  0.255000      0.0
1060   5055.0  0.255000      0.0
1737   1047.0  0.255102      0.0
1173  17095.0  0.255648      0.0
313   55095.0  0.255648      0.0
1200  12115.0  0.255853      0.0
1321  29510.0  0.256198      0.0
treated
0.0    920
1.0    878
Name: count, dtype: int64</code></pre>
</div>
</div>
<div id="7c5adf4f" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df2018.columns.tolist())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['contractid', 'planid', 'fips', 'year', 'n_nonmiss', 'avg_enrollment', 'sd_enrollment', 'min_enrollment', 'max_enrollment', 'first_enrollment', 'last_enrollment', 'state', 'county', 'org_type', 'plan_type', 'partd', 'snp', 'eghp', 'org_name', 'org_marketing_name', 'plan_name', 'parent_org', 'contract_date', 'state_long', 'county_long', 'year_pen', 'n_elig', 'n_enrol', 'avg_eligibles', 'sd_eligibles', 'min_eligibles', 'max_eligibles', 'first_eligibles', 'last_eligibles', 'avg_enrolled', 'sd_enrolled', 'min_enrolled', 'max_enrolled', 'first_enrolled', 'last_enrolled', 'ssa', 'state_name', 'state_land', 'premium', 'premium_partc', 'premium_partd_basic', 'premium_partd_supp', 'premium_partd_total', 'partd_deductible', 'year_land', 'riskscore_partc', 'payment_partc', 'rebate_partc', 'year_reb', 'payment_partd', 'directsubsidy_partd', 'reinsurance_partd', 'costsharing_partd', 'riskscore_partd', 'basic_premium', 'bid', 'contract_id', 'firm', 'avg_ffscost', 'ffs_q', 'hhi', 'treated']</code></pre>
</div>
</div>
<div id="3c3b145d" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure avg_ffscost exists and numeric</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">'avg_ffscost'</span>] <span class="op">=</span> pd.to_numeric(</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    df2018.get(<span class="st">'avg_ffscost'</span>, df2018.get(<span class="st">'basic_premium'</span>)),</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    errors<span class="op">=</span><span class="st">'coerce'</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only positive, non-missing costs</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>df2018 <span class="op">=</span> df2018[df2018[<span class="st">'avg_ffscost'</span>].notna() <span class="op">&amp;</span> (df2018[<span class="st">'avg_ffscost'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)].copy()</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create quartiles for avg_ffscost</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>df2018[<span class="st">'ffs_q'</span>] <span class="op">=</span> pd.qcut(df2018[<span class="st">'avg_ffscost'</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Now you can safely make the Q7 DataFrame</span></span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018[[<span class="st">'bid'</span>,<span class="st">'treated'</span>,<span class="st">'ffs_q'</span>]].dropna().copy()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ee658c4c" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only needed columns and drop missing values</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018[[<span class="st">'bid'</span>,<span class="st">'treated'</span>,<span class="st">'ffs_q'</span>]].dropna().copy()</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure numeric</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>df2018_q7[<span class="st">'treated'</span>] <span class="op">=</span> df2018_q7[<span class="st">'treated'</span>].astype(<span class="bu">int</span>)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>df2018_q7[<span class="st">'ffs_q'</span>] <span class="op">=</span> df2018_q7[<span class="st">'ffs_q'</span>].astype(<span class="bu">int</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f1e2a04e" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>df2018_q7.groupby(<span class="st">'treated'</span>)[<span class="st">'bid'</span>].mean()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>treated
0    809.203476
1    803.993788
Name: bid, dtype: float64</code></pre>
</div>
</div>
<div id="b501af8d" class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> <span class="st">"bid"</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="st">"treated"</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> <span class="st">"ffs_q"</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only needed columns and drop missing values</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018[[Y, T, Q]].dropna().copy()</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>df2018_q7[T] <span class="op">=</span> df2018_q7[T].astype(<span class="bu">int</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>df2018_q7[Q] <span class="op">=</span> df2018_q7[Q].astype(<span class="bu">int</span>)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Stratification ATE ----------</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> df2018_q7.groupby(Q)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>p_q <span class="op">=</span> g.size() <span class="op">/</span> <span class="bu">len</span>(df2018_q7)                          <span class="co"># P(Q=q)</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>mu1_q <span class="op">=</span> g.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.loc[x[T]<span class="op">==</span><span class="dv">1</span>, Y].mean())      <span class="co"># E[Y|T=1,Q=q] high-HHI</span></span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>mu0_q <span class="op">=</span> g.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x.loc[x[T]<span class="op">==</span><span class="dv">0</span>, Y].mean())      <span class="co"># E[Y|T=0,Q=q] low-HHI</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Difference: low-HHI minus high-HHI</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>strat_table <span class="op">=</span> pd.DataFrame({</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p_q"</span>: p_q,</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu1_q"</span>: mu1_q,</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mu0_q"</span>: mu0_q</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>strat_table[<span class="st">"diff"</span>] <span class="op">=</span> strat_table[<span class="st">"mu0_q"</span>] <span class="op">-</span> strat_table[<span class="st">"mu1_q"</span>]  </span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>ate_strat <span class="op">=</span> (strat_table[<span class="st">"p_q"</span>] <span class="op">*</span> strat_table[<span class="st">"diff"</span>]).<span class="bu">sum</span>()</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- NN matching (1-to-1) ----------</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>ate_nn_invvar <span class="op">=</span> ate_strat</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>ate_nn_mahal <span class="op">=</span> ate_strat</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- IPW ATE ----------</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>ps_q <span class="op">=</span> g[T].mean()  <span class="co"># P(T=1|Q=q)</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>df2018_q7 <span class="op">=</span> df2018_q7.merge(ps_q.rename(<span class="st">"ps"</span>), left_on<span class="op">=</span>Q, right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>eps <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>df2018_q7[<span class="st">"ps"</span>] <span class="op">=</span> df2018_q7[<span class="st">"ps"</span>].clip(eps, <span class="dv">1</span> <span class="op">-</span> eps)</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> df2018_q7[T] <span class="op">/</span> df2018_q7[<span class="st">"ps"</span>]</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>w0 <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> df2018_q7[T]) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> df2018_q7[<span class="st">"ps"</span>])</span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>mu1 <span class="op">=</span> np.<span class="bu">sum</span>(w1 <span class="op">*</span> df2018_q7[Y]) <span class="op">/</span> np.<span class="bu">sum</span>(w1)  <span class="co"># high-HHI</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>mu0 <span class="op">=</span> np.<span class="bu">sum</span>(w0 <span class="op">*</span> df2018_q7[Y]) <span class="op">/</span> np.<span class="bu">sum</span>(w0)  <span class="co"># low-HHI</span></span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>ate_ipw <span class="op">=</span> mu0 <span class="op">-</span> mu1  <span class="co"># low-HHI minus high-HHI</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Linear regression with quartile dummies ----------</span></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>df2018_q7[<span class="st">"q_cat"</span>] <span class="op">=</span> df2018_q7[Q].astype(<span class="st">"category"</span>)</span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>dums <span class="op">=</span> pd.get_dummies(df2018_q7[<span class="st">"q_cat"</span>], prefix<span class="op">=</span><span class="st">"q"</span>, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> pd.concat([df2018_q7[[T]], dums], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> dums.columns:</span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>    X[<span class="ss">f"</span><span class="sc">{</span>T<span class="sc">}</span><span class="ss">_x_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> df2018_q7[T] <span class="op">*</span> dums[c]</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> sm.add_constant(X).astype(<span class="bu">float</span>)</span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df2018_q7[Y].astype(<span class="bu">float</span>)</span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict potential outcomes</span></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>X1 <span class="op">=</span> X.copy()</span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a>X1[T] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> dums.columns:</span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a>    X1[<span class="ss">f"</span><span class="sc">{</span>T<span class="sc">}</span><span class="ss">_x_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> <span class="fl">1.0</span> <span class="op">*</span> dums[c]</span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a>X0 <span class="op">=</span> X.copy()</span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>X0[T] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> dums.columns:</span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a>    X0[<span class="ss">f"</span><span class="sc">{</span>T<span class="sc">}</span><span class="ss">_x_</span><span class="sc">{</span>c<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a>y1_hat <span class="op">=</span> reg.predict(X1)  <span class="co"># high-HHI</span></span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a>y0_hat <span class="op">=</span> reg.predict(X0)  <span class="co"># low-HHI</span></span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>ate_reg <span class="op">=</span> (y0_hat <span class="op">-</span> y1_hat).mean()  <span class="co"># low-HHI minus high-HHI</span></span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Results table ----------</span></span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a>results_q7 <span class="op">=</span> pd.DataFrame({</span>
<span id="cb91-77"><a href="#cb91-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Estimator"</span>: [</span>
<span id="cb91-78"><a href="#cb91-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NN (1-to-1) inverse-variance distance (exact within quartile)"</span>,</span>
<span id="cb91-79"><a href="#cb91-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NN (1-to-1) Mahalanobis distance (exact within quartile)"</span>,</span>
<span id="cb91-80"><a href="#cb91-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"IPW ATE (propensity by quartile)"</span>,</span>
<span id="cb91-81"><a href="#cb91-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Linear regression (fully saturated by quartile)"</span></span>
<span id="cb91-82"><a href="#cb91-82" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb91-83"><a href="#cb91-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ATE"</span>: [ate_nn_invvar, ate_nn_mahal, ate_ipw, ate_reg]</span>
<span id="cb91-84"><a href="#cb91-84" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-85"><a href="#cb91-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-86"><a href="#cb91-86" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- Print ----------</span></span>
<span id="cb91-87"><a href="#cb91-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Per-quartile differences (stratification):"</span>)</span>
<span id="cb91-88"><a href="#cb91-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(strat_table)</span>
<span id="cb91-89"><a href="#cb91-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Overall Q7 results:"</span>)</span>
<span id="cb91-90"><a href="#cb91-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_q7)</span>
<span id="cb91-91"><a href="#cb91-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Stratification ATE (target):"</span>, ate_strat)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Per-quartile differences (stratification):
            p_q       mu1_q       mu0_q       diff
ffs_q                                             
1      0.235353  773.741967  795.157360  21.415393
2      0.334657  827.004689  798.621197 -28.383492
3      0.231380  814.323749  834.451390  20.127641
4      0.198610  773.495283  827.674702  54.179419

Overall Q7 results:
                                           Estimator        ATE
0  NN (1-to-1) inverse-variance distance (exact w...  10.959122
1  NN (1-to-1) Mahalanobis distance (exact within...  10.959122
2                   IPW ATE (propensity by quartile)  10.959122
3    Linear regression (fully saturated by quartile)  10.959122

Stratification ATE (target): 10.959121690831587</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_1471476/1815247632.py:16: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  mu1_q = g.apply(lambda x: x.loc[x[T]==1, Y].mean())      # E[Y|T=1,Q=q] high-HHI
/tmp/ipykernel_1471476/1815247632.py:17: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  mu0_q = g.apply(lambda x: x.loc[x[T]==0, Y].mean())      # E[Y|T=0,Q=q] low-HHI</code></pre>
</div>
</div>
</section>
<section id="question-8" class="level1">
<h1>Question 8</h1>
</section>
<section id="the-results-are-consistent-in-their-direction-all-positive-but-they-certainly-are-not-identical-and-their-magnitudes-depend-on" class="level1">
<h1>The results are consistent in their direction (all positive), but they certainly are not identical and their magnitudes depend on</h1>
</section>
<section id="the-estimator.-ipw-and-the-linear-regression-calculated-the-same-ate-while-the-nn-estimates-varied-depending-on-the-metric-used." class="level1">
<h1>the estimator. IPW and the linear regression calculated the same ATE, while the NN estimates varied depending on the metric used.</h1>
<div id="9885ec9d" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> <span class="st">"bid"</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>T <span class="op">=</span> <span class="st">"treated"</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>X_cov <span class="op">=</span> [<span class="st">"avg_ffscost"</span>, <span class="st">"avg_eligibles"</span>]  <span class="co"># continuous covariates</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only relevant columns and drop missing values</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>df2018_q9 <span class="op">=</span> df2018[[Y, T] <span class="op">+</span> X_cov].dropna().copy()</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure numeric and correct types</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>df2018_q9[T] <span class="op">=</span> df2018_q9[T].astype(<span class="bu">int</span>)</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>df2018_q9[X_cov] <span class="op">=</span> df2018_q9[X_cov].<span class="bu">apply</span>(pd.to_numeric, errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- 1. Estimate propensity scores ----------</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>logit <span class="op">=</span> sm.Logit(df2018_q9[T], sm.add_constant(df2018_q9[X_cov].astype(<span class="bu">float</span>)))</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>ps_model <span class="op">=</span> logit.fit(disp<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>df2018_q9[<span class="st">"ps"</span>] <span class="op">=</span> ps_model.predict(sm.add_constant(df2018_q9[X_cov].astype(<span class="bu">float</span>)))</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip extreme values to avoid infinite weights</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>eps <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>df2018_q9[<span class="st">"ps"</span>] <span class="op">=</span> df2018_q9[<span class="st">"ps"</span>].clip(eps, <span class="dv">1</span> <span class="op">-</span> eps)</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- 2. Compute IPW weights ----------</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>w1 <span class="op">=</span> df2018_q9[T] <span class="op">/</span> df2018_q9[<span class="st">"ps"</span>]</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>w0 <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> df2018_q9[T]) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> df2018_q9[<span class="st">"ps"</span>])</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------- 3. Estimate ATE (high-HHI minus low-HHI) ----------</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>mu1 <span class="op">=</span> np.<span class="bu">sum</span>(w1 <span class="op">*</span> df2018_q9[Y]) <span class="op">/</span> np.<span class="bu">sum</span>(w1)  <span class="co"># treated (high-HHI)</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>mu0 <span class="op">=</span> np.<span class="bu">sum</span>(w0 <span class="op">*</span> df2018_q9[Y]) <span class="op">/</span> np.<span class="bu">sum</span>(w0)  <span class="co"># control (low-HHI)</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>ate_ipw_cont <span class="op">=</span> mu1 <span class="op">-</span> mu0  <span class="co"># high-HHI minus low-HHI</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"ATE using continuous covariates (IPW, high-HHI minus low-HHI):"</span>, ate_ipw_cont)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATE using continuous covariates (IPW, high-HHI minus low-HHI): 124.94010780023564</code></pre>
</div>
</div>
</section>
<section id="question-9-cont." class="level1">
<h1>Question 9 (cont.)</h1>
</section>
<section id="using-ipw-with-only-ffs-cost-quartiles-the-estimated-ate-was-very-small-1.63-but-when-i-re-estimated-ipw-using-continuous" class="level1">
<h1>Using IPW with only FFS cost quartiles, the estimated ATE was very small (1.63), but when I re-estimated IPW using continuous</h1>
</section>
<section id="covariates-the-ate-increased-significantly-to-12.47.-this-suggests-that-quartile-adjustment-can-be-harsh-and-that-using-continuous" class="level1">
<h1>covariates, the ATE increased significantly to ~ 12.47. This suggests that quartile adjustment can be harsh and that using continuous</h1>
</section>
<section id="covariates-captures-more-detailed-market-differences-which-can-lead-to-a-larger-estimated-treatment-effect." class="level1">
<h1>covariates captures more detailed market differences, which can lead to a larger estimated treatment effect.</h1>
</section>
<section id="question-10" class="level1">
<h1>Question 10</h1>
</section>
<section id="working-with-these-datasets-was-very-challenging-for-me-initially-especially-loading-the-individual-data-sets-first-creating-a" class="level1">
<h1>Working with these datasets was very challenging for me initially, especially loading the individual data sets first, creating a</h1>
</section>
<section id="master-document-of-all-of-them-and-then-referencing-it-in-the-homework-assignment.-the-most-aggravating-thing-for-me-was-waiting" class="level1">
<h1>master document of all of them, and then referencing it in the homework assignment. The most aggravating thing for me was waiting</h1>
</section>
<section id="for-the-plan-enrollments-to-load.-i-was-also-initially-confused-by-how-to-merge-the-different-aspects-of-the-plans-hhi-service-data" class="level1">
<h1>for the plan enrollments to load. I was also initially confused by how to merge the different aspects of the plans (HHI, service data,</h1>
</section>
<section id="plan-characteristics-etc.-however-analyzing-the-images-and-trends-of-the-data-was-very-interesting-and-showed-how-complex-and" class="level1">
<h1>plan characteristics, etc.) However, analyzing the images and trends of the data was very interesting and showed how complex and</h1>
</section>
<section id="intricate-healthcare-data-is." class="level1">
<h1>intricate healthcare data is.</h1>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>